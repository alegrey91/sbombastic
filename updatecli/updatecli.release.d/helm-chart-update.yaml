name: Update SBOMscanner chart versions

sources:
  chartVersion:
    name: "Get latest sbomscanner helm version"
    kind: yaml
    transformers:
      - semverinc: patch
    spec:
      file: charts/sbomscanner/Chart.yaml
      key: $.version
  releaseVersion:
    name: "Get latest sbomscanner version"
    kind: githubrelease
    spec:
      owner: "{{ requiredEnv .github.owner }}"
      repository: sbomscanner
      token: "{{ requiredEnv .github.token }}"
      typefilter:
        prerelease: true
        release: true
        draft: false
      versionfilter:
        kind: "semver"
        pattern: ">=0.0.0-0" # include pre-release, release

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.author }}"
      email: "{{ .github.email }}"
      owner: "{{ requiredEnv .github.owner }}"
      repository: "sbomscanner"
      token: "{{ requiredEnv .github.token }}"
      username: "{{ requiredEnv .github.user }}"
      branch: "{{ .github.branch }}"
      commitmessage:
        type: "chore"
        title: "Update SBOMscanner Helm charts"
        hidecredit: true
        footers: "Signed-off-by: SBOMscanner bot <sbomscanner-bot@users.noreply.github.com>"

actions:
  default:
    title: 'chore: Helm chart {{ source "chartVersion" }} release'
    kind: github/pullrequest
    scmid: default
    spec:
      automerge: false
      mergemethod: squash
      description: |
        Automatic Helm chart {{ source "chartVersion" }} update.
        This PR has been created by the automation used to automatically update the Helm charts when SBOMscanner is released or helm chart content is updated.
        REMEMBER IF YOU WANT TO MERGE IN A SINGLE COMMIT CHANGES AND VERSION BUMP, YOU MUST SQUASH THE COMMIT BEFORE MERGING THIS PR!
      draft: false
      labels:
        - "chore"

targets:
  update_helm_version:
    scmid: default
    name: Update Helm chart version
    kind: yaml
    sourceid: chartVersion
    spec:
      file: charts/sbomscanner/Chart.yaml
      key: $.version
  update_appversion:
    scmid: default
    name: Update Helm chart appVersion
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/sbomscanner/Chart.yaml
      key: $.appVersion
  update_controller_version:
    scmid: default
    name: Update Helm chart controller version
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/sbomscanner/values.yaml
      key: $.controller.image.tag
  update_storage_version:
    scmid: default
    name: Update Helm chart storage version
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/sbomscanner/values.yaml
      key: $.storage.image.tag
  update_worker_version:
    scmid: default
    name: Update Helm chart worker version
    kind: yaml
    sourceid: releaseVersion
    spec:
      file: charts/sbomscanner/values.yaml
      key: $.worker.image.tag

